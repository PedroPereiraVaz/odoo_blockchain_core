<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <template id="verification_page_template" name="Blockchain Verification">
        <t t-call="website.layout">
            <div class="container mt-5 mb-5">
                <div class="row justify-content-center">
                    <div class="col-lg-8">
                        <div class="card shadow-sm">
                            <div class="card-body p-5 text-center">
                                <h2 class="mb-4 text-primary">
                                    <i class="fa fa-shield me-2"/>Verificador Universal
                                </h2>
                                <p class="text-muted mb-5">
                                    Arrastra tu documento original (PDF, JPG...) para verificar su autenticidad directamente en la Blockchain.
                                    <br/>
                                    <small>El documento se procesa en tu navegador. <strong>Nunca se sube al servidor.</strong></small>
                                </p>

                                <!-- Drop Zone -->
                                <div id="dropZone" class="p-5 mb-4 bg-light border rounded-3 position-relative" style="border: 2px dashed #cbd5e1 !important; cursor: pointer;">
                                    <i class="fa fa-file-text-o fa-4x text-muted mb-3"/>
                                    <h5 class="text-dark">Arrastra tu archivo aquí</h5>
                                    <p class="text-muted small">o haz clic para seleccionar</p>
                                    <input type="file" id="fileInput" class="position-absolute top-0 start-0 w-100 h-100 opacity-0" style="cursor: pointer;"/>
                                </div>
                                <div id="selectedFile" class="mb-4 fw-bold text-primary d-none"></div>

                                <!-- Config Hidden Data -->
                                <input type="hidden" id="configRpc" t-att-value="rpc_url"/>
                                <input type="hidden" id="configAddress" t-att-value="contract_address"/>

                                <button id="verifyBtn" class="btn btn-primary btn-lg w-100" disabled="disabled">
                                    <i class="fa fa-search me-2"/>Verificar Documento
                                </button>

                                <!-- Result Area -->
                                <div id="resultArea" class="mt-4 text-start d-none p-3 rounded-3 border">
                                    <!-- Dynamic Content -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Scripts -->
            <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
            <script type="text/javascript">
                document.addEventListener('DOMContentLoaded', function() {
                    const dropZone = document.getElementById('dropZone');
                    const fileInput = document.getElementById('fileInput');
                    const verifyBtn = document.getElementById('verifyBtn');
                    const resultArea = document.getElementById('resultArea');
                    const selectedFileDiv = document.getElementById('selectedFile');
                    
                    const rpcUrl = document.getElementById('configRpc').value;
                    const contractAddr = document.getElementById('configAddress').value;

                    let selectedFile = null;
                    const CONTRACT_ABI = [
                        {"inputs": [{"internalType": "bytes32", "name": "_hash", "type": "bytes32"}], "name": "verifyDocument", "outputs": [{"internalType": "bool", "name": "isValid", "type": "bool"}, {"internalType": "string", "name": "issuerName", "type": "string"}, {"internalType": "string", "name": "issuerTaxId", "type": "string"}, {"internalType": "uint256", "name": "timestamp", "type": "uint256"}, {"internalType": "address", "name": "issuerAddress", "type": "address"}], "stateMutability": "view", "type": "function"},
                        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "bytes32", "name": "docHash", "type": "bytes32"}, {"indexed": true, "internalType": "address", "name": "issuer", "type": "address"}], "name": "DocumentRevoked", "type": "event"},
                        {"anonymous": false, "inputs": [{"indexed": true, "internalType": "bytes32", "name": "docHash", "type": "bytes32"}, {"indexed": true, "internalType": "address", "name": "issuer", "type": "address"}], "name": "DocumentRegistered", "type": "event"}
                    ];

                    function getExplorerUrl(chainId, txHash) {
                        let baseUrl = "https://etherscan.io/tx/";
                        if (chainId === 11155111) baseUrl = "https://sepolia.etherscan.io/tx/";
                        else if (chainId === 137) baseUrl = "https://polygonscan.com/tx/";
                        else if (chainId === 80002) baseUrl = "https://amoy.polygonscan.com/tx/";
                        return baseUrl + txHash;
                    }

                    // Drag &amp; Drop Visuals
                    dropZone.addEventListener('dragover', (e) => { e.preventDefault(); dropZone.classList.add('bg-white'); dropZone.classList.remove('bg-light'); });
                    dropZone.addEventListener('dragleave', () => { dropZone.classList.add('bg-light'); dropZone.classList.remove('bg-white'); });
                    dropZone.addEventListener('drop', (e) => { 
                        e.preventDefault(); 
                        dropZone.classList.add('bg-light'); 
                        dropZone.classList.remove('bg-white');
                        if(e.dataTransfer.files.length) handleFile(e.dataTransfer.files[0]);
                    });

                    fileInput.addEventListener('change', (e) => {
                        if(e.target.files.length) handleFile(e.target.files[0]);
                    });

                    function handleFile(file) {
                        selectedFile = file;
                        selectedFileDiv.innerHTML = `<i class="fa fa-check-circle me-1"/> ${file.name} (${(file.size/1024).toFixed(2)} KB)`;
                        selectedFileDiv.classList.remove('d-none');
                        verifyBtn.disabled = false;
                        resultArea.classList.add('d-none');
                    }

                    // Hashing
                    async function calculateHash(file) {
                        const buffer = await file.arrayBuffer();
                        const hashBuffer = await crypto.subtle.digest('SHA-256', buffer);
                        const hashArray = Array.from(new Uint8Array(hashBuffer));
                        return '0x' + hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
                    }

                    verifyBtn.addEventListener('click', async () => {
                        if (!selectedFile) return;
                        
                        verifyBtn.disabled = true;
                        verifyBtn.innerHTML = '<i class="fa fa-spinner fa-spin me-2"/>Verificando...';
                        resultArea.classList.add('d-none');

                        try {
                            if (!rpcUrl || !contractAddr) throw new Error("La configuración de Blockchain no está completa en el sistema.");

                            const docHash = await calculateHash(selectedFile);
                            console.log("Calculated Hash:", docHash);

                            // Provider
                            let provider;
                            if (rpcUrl.includes('infura') || rpcUrl.includes('alchemy') || rpcUrl.startsWith('http')) {
                                provider = new ethers.providers.JsonRpcProvider(rpcUrl);
                            } else {
                                provider = ethers.getDefaultProvider();
                            }

                            const contract = new ethers.Contract(contractAddr, CONTRACT_ABI, provider);
                            const result = await contract.verifyDocument(docHash);
                            
                            
                            const isValid = result[0];
                            const issuerName = result[1];
                            const issuerTax = result[2];
                            const timestamp = result[3]; // uint256 (BigNumber)
                            
                            // Ethers.js BigNumber check for zero
                            const isRegistered = !timestamp.eq(0); 

                            // Safe conversion for date (timestamp fits in JS number)
                            const date = new Date(timestamp.toNumber() * 1000).toLocaleString();

                            resultArea.classList.remove('d-none', 'alert-success', 'alert-danger', 'alert-warning');
                            resultArea.innerHTML = '';

                            // Get Chain ID for Explorer URL
                            const network = await provider.getNetwork();
                            const chainId = network.chainId;
                            let txLinkHtml = "";

                            if (isValid) {
                                // CASE 1: VALID - Fetch Registration Transaction
                                try {
                                    const filter = contract.filters.DocumentRegistered(docHash);
                                    const events = await contract.queryFilter(filter);
                                    if (events.length > 0) {
                                        const txHash = events[0].transactionHash;
                                        const url = getExplorerUrl(chainId, txHash);
                                        txLinkHtml = `<p class="mb-0 mt-3"><a href="${url}" target="_blank" class="btn btn-outline-success btn-sm"><i class="fa fa-external-link me-1"/>Ver en Blockchain</a></p>`;
                                    }
                                } catch (e) { console.warn("Error fetching registration tx", e); }

                                resultArea.classList.add('alert', 'alert-success');
                                resultArea.innerHTML = `
                                    <h4 class="alert-heading"><i class="fa fa-check-circle me-2"/>Documento Válido</h4>
                                    <hr/>
                                    <p class="mb-1"><strong>Emisor:</strong> ${issuerName}</p>
                                    <p class="mb-1"><strong>ID Fiscal:</strong> ${issuerTax}</p>
                                    <p class="mb-1"><strong>Fecha de Emisión:</strong> ${date}</p>
                                    <p class="mb-0 mt-2"><small>Hash: ${docHash}</small></p>
                                    ${txLinkHtml}
                                `;
                            } else if (isRegistered) {
                                // CASE 2: REVOKED - Fetch Revocation Transaction
                                let revokedDateStr = "No disponible";
                                
                                try {
                                    const filter = contract.filters.DocumentRevoked(docHash);
                                    const events = await contract.queryFilter(filter);
                                    
                                    if(events.length > 0) {
                                        const lastEvent = events[events.length - 1];
                                        const block = await lastEvent.getBlock();
                                        revokedDateStr = new Date(block.timestamp * 1000).toLocaleString();
                                        
                                        const txHash = lastEvent.transactionHash;
                                        const url = getExplorerUrl(chainId, txHash);
                                        txLinkHtml = `<p class="mb-0 mt-3"><a href="${url}" target="_blank" class="btn btn-outline-warning btn-sm"><i class="fa fa-external-link me-1"/>Ver Revocación</a></p>`;
                                    }
                                } catch (logErr) {
                                    console.warn("Could not fetch revocation logs:", logErr);
                                }

                                resultArea.classList.add('alert', 'alert-warning');
                                resultArea.innerHTML = `
                                    <h4 class="alert-heading"><i class="fa fa-ban me-2"/>Documento Revocado</h4>
                                    <hr/>
                                    <p class="mb-1"><strong>Emisor:</strong> ${issuerName}</p>
                                    <p class="mb-1"><strong>ID Fiscal:</strong> ${issuerTax}</p>
                                    <p class="mb-1"><strong>Fecha de Emisión:</strong> ${date}</p>
                                    <p class="mb-1 text-danger"><strong>Fecha de Revocación:</strong> ${revokedDateStr}</p>
                                    <p class="mb-0 mt-2"><small>Hash: ${docHash}</small></p>
                                    ${txLinkHtml}
                                `;
                            } else {
                                // CASE 3: NOT REGISTERED (Timestamp is 0)
                                resultArea.classList.add('alert', 'alert-danger');
                                resultArea.innerHTML = `
                                    <h4 class="alert-heading"><i class="fa fa-times-circle me-2"/>Documento No Registrado</h4>
                                    <hr/>
                                    <p class="mb-1">El documento no se encuentra en el registro oficial.</p>
                                    <p class="mb-1">Podría no haber sido emitido nunca o haber sido modificado.</p>
                                    <p class="mb-0 mt-2"><small>Hash: ${docHash}</small></p>
                                `;
                            }

                        } catch (error) {
                            console.error(error);
                            resultArea.classList.remove('d-none');
                            resultArea.classList.add('alert', 'alert-warning');
                            resultArea.innerHTML = `
                                <h4 class="alert-heading"><i class="fa fa-exclamation-triangle me-2"/>Error</h4>
                                <p>${error.message || "Error de conexión con Blockchain"}</p>
                            `;
                        } finally {
                            verifyBtn.disabled = false;
                            verifyBtn.innerHTML = '<i class="fa fa-search me-2"/>Verificar Documento';
                        }
                    });
                });
            </script>
        </t>
    </template>
</odoo>
